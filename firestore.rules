/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user profiles and data.
 * All data is nested under specific collections (e.g., /users/{userId}, /projects/{projectId}).
 *
 * Data Structure:
 * - /users/{userId}: User profile information; only the authenticated user can read/write their own profile.
 * - /users/{userId}/notifications/{notificationId}: Notifications for a specific user; only the user can access their own notifications.
 * - /teams/{teamId}: Team information; create, update and delete operations denied.
 * - /roles/{roleId}: Role information; create, update and delete operations denied.
 * - /contacts/{contactId}: Contact information; create, update and delete operations denied.
 * - /projects/{projectId}: Project information; only team members can access the project data.
 * - /projects/{projectId}/stages/{stageId}: Stages within a project; only team members can access the stage data.
 * - /projects/{projectId}/tasks/{taskId}: Tasks within a stage; only team members can access the task data.
 * - /projects/{projectId}/files/{fileId}: Files associated with a project; only team members can access the files.
 * - /chats/{chatId}: Chat conversation metadata; only participating users can access the chat.
 * - /chats/{chatId}/messages/{messageId}: Messages within a chat; only participating users can access the messages.
 * - /products/{productId}: Product information; create, update and delete operations denied.
 * - /seals/{sealId}: Seal information; create, update and delete operations denied.
 * - /checklists/{checklistId}: Checklist templates; create, update and delete operations denied.
 * - /checklists/{checklistId}/items/{itemId}: Items for a specific checklist; create, update and delete operations denied.
 *
 * Key Security Decisions:
 * - User listing is explicitly disallowed.
 * - Default security posture for ambiguous relationships is strict owner-only access.
 * - Assumes that Project documents contain a `teamMembers` array.
 *
 * Denormalization for Authorization:
 * - Assumes that the projects documents contains the `teamMembers` with user IDs.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces that only the authenticated user can read and write their own profile data.
     * @path /users/{userId}
     * @allow (create, update, get, list): If the authenticated user's ID matches the userId.
     * @deny (create, update, get, list): If the authenticated user's ID does not match the userId.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Listing users is not permitted.
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Enforces that only the authenticated user can read and write their own notifications.
     * @path /users/{userId}/notifications/{notificationId}
     * @allow (create, update, get, list): If the authenticated user's ID matches the userId.
     * @deny (create, update, get, list): If the authenticated user's ID does not match the userId.
     * @principle Restricts access to a user's own notifications.
     */
    match /users/{userId}/notifications/{notificationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Restricts read access to teams. No create, update or delete operations allowed.
     * @path /teams/{teamId}
     * @allow get, list: if false;
     * @deny create, update, delete: Always.
     * @principle Restricts access to team data.
     */
    match /teams/{teamId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Restricts access to roles. No create, update or delete operations allowed.
     * @path /roles/{roleId}
     * @allow get, list: if false;
     * @deny create, update, delete: Always.
     * @principle Restricts access to role data.
     */
    match /roles/{roleId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

   /**
    * @description Restricts access to contacts. No create, update or delete operations allowed.
    * @path /contacts/{contactId}
    * @allow get, list: if false;
    * @deny create, update, delete: Always.
    */
    match /contacts/{contactId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants access to project data to team members.
     * @path /projects/{projectId}
     * @allow get, list: If the authenticated user is a member of the project's team.
     * @allow create, update, delete: If the authenticated user is the owner of the project.
     * @principle Enforces team-based access to project data.
     */
    match /projects/{projectId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isTeamMember() {
        return isSignedIn() && request.auth.uid in resource.data.teamMembers;
      }

      function isOwner(ownerId) {
        return isSignedIn() && request.auth.uid == ownerId;
      }

      function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
      }

      allow get: if isTeamMember();
      allow list: if false; // Listing is not permitted.
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.ownerId);
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Grants access to stage data within a project to team members.
     * @path /projects/{projectId}/stages/{stageId}
     */
    match /projects/{projectId}/stages/{stageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isTeamMember() {
        return isSignedIn() && get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers.hasAny([request.auth.uid]);
      }

      allow get: if isTeamMember();
      allow list: if isTeamMember();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants access to task data within a project to team members.
     * @path /projects/{projectId}/tasks/{taskId}
     */
    match /projects/{projectId}/tasks/{taskId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isTeamMember() {
        return isSignedIn() && get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers.hasAny([request.auth.uid]);
      }

      allow get: if isTeamMember();
      allow list: if isTeamMember();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants access to files data within a project to team members.
     * @path /projects/{projectId}/files/{fileId}
     */
    match /projects/{projectId}/files/{fileId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isTeamMember() {
        return isSignedIn() && get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers.hasAny([request.auth.uid]);
      }

      allow get: if isTeamMember();
      allow list: if isTeamMember();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

   /**
    * @description Grants access to chat metadata to participating users.
    * @path /chats/{chatId}
    */
    match /chats/{chatId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isParticipant() {
        return isSignedIn() && request.auth.uid in resource.data.userIds;
      }

      allow get: if isParticipant();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants access to messages within a chat to participating users.
     * @path /chats/{chatId}/messages/{messageId}
     */
    match /chats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isParticipant() {
        return isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.userIds.hasAny([request.auth.uid]);
      }

      allow get: if isParticipant();
      allow list: if isParticipant();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Restricts access to product data. No create, update or delete operations allowed.
     * @path /products/{productId}
     */
    match /products/{productId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Restricts access to seal data. No create, update or delete operations allowed.
     * @path /seals/{sealId}
     */
    match /seals/{sealId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Restricts access to checklist data. No create, update or delete operations allowed.
     * @path /checklists/{checklistId}
     */
    match /checklists/{checklistId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Restricts access to checklist item data. No create, update or delete operations allowed.
     * @path /checklists/{checklistId}/items/{itemId}
     */
    match /checklists/{checklistId}/items/{itemId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}