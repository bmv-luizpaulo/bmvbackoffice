/**
 * @file Firebase Security Rules for Firestore.
 * @description This ruleset enforces a user-ownership model for user profiles and a shared access model for projects, stages, and tasks.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles. Only the authenticated user can read or write their own profile.
 * - /projects/{projectId}: Stores project data. Access is controlled via the `ownerId` field, which determines who has full control.  `teamMembers` array controls shared access.
 * - /projects/{projectId}/stages/{stageId}: Stages within a project, accessible to project members.
 * - /projects/{projectId}/tasks/{taskId}: Tasks within a project, accessible to project members.
 *
 * Key Security Decisions:
 * - Users can only access their own user document.
 * - Projects are secured using a shared access pattern based on the `ownerId` and `teamMembers` field. The owner can read/write, team members can read.
 * - Stages and tasks inherit access control from their parent project.
 * - Data shape validation is relaxed for rapid prototyping, focusing on authorization.
 *
 * Denormalization for Authorization:
 * - Project documents denormalize `ownerId` and `teamMembers` directly on the document. This avoids the need for costly `get()` calls to a separate collection to determine project ownership or membership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles.  Users can only read and write their own profile.
     * @path /users/{userId}
     * @allow (create) User with ID 'user_abc' can create their own profile.
     *   - request.auth.uid: 'user_abc'
     *   - request.resource.data.id: 'user_abc'
     * @allow (get, update, delete) User with ID 'user_abc' can read/write their profile.
     *   - request.auth.uid: 'user_abc'
     *   - resource.data.id: 'user_abc'
     * @deny (create) User with ID 'user_abc' cannot create a profile for another user.
     *   - request.auth.uid: 'user_abc'
     *   - request.resource.data.id: 'user_xyz'
     * @deny (get, update, delete) User with ID 'user_abc' cannot read/write another user's profile.
     *   - request.auth.uid: 'user_abc'
     *   - resource.data.id: 'user_xyz'
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // User listing is not permitted.
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Controls access to projects. Owners have full access, and team members have read access.
     * @path /projects/{projectId}
     * @allow (create) User with ID 'user_abc' can create a project where they are the owner.
     *   - request.auth.uid: 'user_abc'
     *   - request.resource.data.ownerId: 'user_abc'
     * @allow (get, list) Any signed-in user can view the project.
     *   - request.auth.uid: 'user_xyz'
     * @allow (update, delete) User with ID 'user_abc' can update/delete a project where they are the owner.
     *   - request.auth.uid: 'user_abc'
     *   - resource.data.ownerId: 'user_abc'
     * @deny (create) User with ID 'user_abc' cannot create a project with another user as the owner.
     *   - request.auth.uid: 'user_abc'
     *   - request.resource.data.ownerId: 'user_xyz'
     * @deny (update, delete) User with ID 'user_xyz' cannot update/delete a project where user 'user_abc' is the owner.
     *   - request.auth.uid: 'user_xyz'
     *   - resource.data.ownerId: 'user_abc'
     * @principle Enforces project ownership and shared access via ownerId and teamMembers.
     */
    match /projects/{projectId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isProjectOwner(projectId);
      allow delete: if isProjectOwner(projectId);
    }

    /**
     * @description Controls access to stages within a project.  Access is inherited from the parent project.
     * @path /projects/{projectId}/stages/{stageId}
     * @allow (get, list) Signed-in user can get and list the stages if part of project.
     * @allow (create) Signed-in user can create a stage if owner of the project.
     * @allow (update, delete) Signed-in user can update or delete stage if owner of the project.
     * @deny (create) User can't create a stage if not owner of parent project.
     * @principle Enforces access control inherited from the parent project.
     */
    match /projects/{projectId}/stages/{stageId} {
      allow get, list: if isSignedIn() && isProjectMember(projectId);
      allow create: if isSignedIn() && isProjectOwner(projectId);
      allow update: if isProjectOwner(projectId);
      allow delete: if isProjectOwner(projectId);
    }

    /**
     * @description Controls access to tasks within a project. Access is inherited from the parent project.
     * @path /projects/{projectId}/tasks/{taskId}
     * @allow (get, list) Signed-in user can get and list tasks if part of the project.
     * @allow (create) Signed-in user can create a task if part of the project.
     * @allow (update, delete) Signed-in user can update or delete task if owner of the project.
     * @deny (create) User can't create a task if not a member of the parent project.
     * @principle Enforces access control inherited from the parent project.
     */
    match /projects/{projectId}/tasks/{taskId} {
      allow get, list: if isSignedIn() && isProjectMember(projectId);
      allow create: if isSignedIn() && isProjectMember(projectId);
      allow update: if isProjectOwner(projectId);
      allow delete: if isProjectOwner(projectId);
    }
  }

  // Helper functions

  // Checks if the user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }

  // Checks if the user is the owner of the resource based on the userId.
  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  // Checks if the user is the owner of an existing resource (resource exists).
  function isExistingOwner(userId) {
    return isSignedIn() && get(/databases/$(database)/documents/users/$(userId)).data.id == request.auth.uid;
  }

  //Checks if the user is the owner of the project.
  function isProjectOwner(projectId) {
    return isSignedIn() && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid;
  }

    //Checks if the user is a project owner and that project document exists.
  function isExistingProjectOwner(projectId) {
    return isProjectOwner(projectId) && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid;
  }


  // Checks if the user is a member of the project.
  function isProjectMember(projectId) {
    return isSignedIn() && (get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers.hasAny([request.auth.uid]) || get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid);
  }
}