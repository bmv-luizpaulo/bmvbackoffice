/**
 * @fileoverview Firestore Security Rules for Task and Project Funnel.
 *
 * Core Philosophy:
 * This ruleset enforces a hierarchical ownership model. Projects are secured based on ownerId.
 * Stages and Tasks inherit authorization from their parent Project. This avoids complex `get()` calls
 * and ensures authorization independence.
 *
 * Data Structure:
 * /projects/{projectId} - Root collection for projects.  Each document should contain an `ownerId` field.
 * /projects/{projectId}/stages/{stageId} - Subcollection for stages within a project.
 * /projects/{projectId}/tasks/{taskId} - Subcollection for tasks within a project.
 *
 * Key Security Decisions:
 * - Listing the /users collection is disallowed.  The provided error indicates that this operation is not permitted.
 * - All write operations require authentication (`request.auth != null`).
 * - The `ownerId` field on Projects is critical for authorization and must match the authenticated user's UID on creation.  It is immutable thereafter.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to projects based on ownership. Only the owner can create, update, or delete a project. Anyone can read project information.
     * @path /projects/{projectId}
     * @allow (create) - User with UID 'user123' creates a new project with ownerId 'user123'.
     * @allow (update) - User with UID 'user123' updates a project where resource.data.ownerId is 'user123'.
     * @allow (delete) - User with UID 'user123' deletes a project where resource.data.ownerId is 'user123'.
     * @deny (create) - User with UID 'user456' tries to create a project with ownerId 'user123'.
     * @principle Enforces document ownership for writes; allows public reads.
     */
    match /projects/{projectId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the user is the owner of the project
      function isOwner(ownerId) {
        return isSignedIn() && request.auth.uid == ownerId;
      }

      // Helper function to check if the user is the existing owner of the project
      function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
      }
      
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.ownerId) && request.resource.data.ownerId == resource.data.ownerId;
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Grants access to stages within a project. Only the owner of the project can manage stages. Anyone can read stage information.
     * @path /projects/{projectId}/stages/{stageId}
     * @allow (create) - User with UID 'user123' creates a new stage in project 'project123' where project 'project123' has ownerId 'user123'.
     * @allow (update) - User with UID 'user123' updates a stage in project 'project123' where project 'project123' has ownerId 'user123'.
     * @allow (delete) - User with UID 'user123' deletes a stage in project 'project123' where project 'project123' has ownerId 'user123'.
     * @deny (create) - User with UID 'user456' tries to create a stage in project 'project123' where project 'project123' has ownerId 'user123'.
     * @principle Enforces ownership inherited from the parent project for writes; allows public reads.
     */
    match /projects/{projectId}/stages/{stageId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }
        
      // Helper function to check if the user is the owner of the project
      function isProjectOwner(projectId) {
          return isSignedIn() && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid;
      }
      
      allow get, list: if true;
      allow create: if isProjectOwner(projectId);
      allow update: if isProjectOwner(projectId) && resource != null;
      allow delete: if isProjectOwner(projectId) && resource != null;
    }

    /**
     * @description Grants access to tasks within a project. Only the owner of the project can manage tasks. Anyone can read task information.
     * @path /projects/{projectId}/tasks/{taskId}
     * @allow (create) - User with UID 'user123' creates a new task in project 'project123' where project 'project123' has ownerId 'user123'.
     * @allow (update) - User with UID 'user123' updates a task in project 'project123' where project 'project123' has ownerId 'user123'.
     * @allow (delete) - User with UID 'user123' deletes a task in project 'project123' where project 'project123' has ownerId 'user123'.
     * @deny (create) - User with UID 'user456' tries to create a task in project 'project123' where project 'project123' has ownerId 'user123'.
     * @principle Enforces ownership inherited from the parent project for writes; allows public reads.
     */
    match /projects/{projectId}/tasks/{taskId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }
      
      // Helper function to check if the user is the owner of the project
      function isProjectOwner(projectId) {
          return isSignedIn() && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isProjectOwner(projectId);
      allow update: if isProjectOwner(projectId) && resource != null;
      allow delete: if isProjectOwner(projectId) && resource != null;
    }

    /**
     * @description Explicitly denies listing the /users collection.
     * @path /users
     * @deny (list) - Any user attempting to list documents in the /users collection.
     * @principle Restricts access to a sensitive collection.
     */
    match /users {
        allow list: if false;
        allow get: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }
  }
}