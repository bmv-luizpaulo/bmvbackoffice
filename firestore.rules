rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own user document.
     * @path /users/{userId}
     * @allow (create) request.auth.uid == userId
     * @allow (get, update, delete) request.auth.uid == userId && resource.data.id == userId
     * @deny (create) request.auth == null
     * @deny (get, update, delete) request.auth == null
     * @principle Enforces document ownership.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows users to read and write their own notifications.
     * @path /users/{userId}/notifications/{notificationId}
     * @allow (create) request.auth.uid == userId
     * @allow (get, update, delete) request.auth.uid == userId
     * @deny (create) request.auth == null
     * @deny (get, update, delete) request.auth == null
     * @principle Enforces document ownership for notifications.
     */
    match /users/{userId}/notifications/{notificationId} {
        function isOwner(userId) {
            return request.auth.uid == userId;
        }

        allow get: if isOwner(userId);
        allow list: if false;
        allow create: if request.auth.uid == userId;
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
    }

    /**
     * @description Allows anyone to read teams, but only the owner can modify.
     * @path /teams/{teamId}
     * @allow (get, list) true
     * @allow (create) request.auth.uid == request.resource.data.ownerId
     * @allow (update, delete) request.auth.uid == resource.data.ownerId
     * @deny (create, update, delete) request.auth == null
     * @principle Public read, owner-only writes.
     */
    match /teams/{teamId} {
      function isOwner() {
        return request.auth.uid == resource.data.ownerId;
      }

      allow get: if true;
      allow list: if true;
      allow create: if request.auth.uid == request.resource.data.ownerId;
      allow update: if request.auth.uid == resource.data.ownerId;
      allow delete: if request.auth.uid == resource.data.ownerId;
    }

     /**
     * @description Allows anyone to read roles, but only the owner can modify.
     * @path /roles/{roleId}
     * @allow (get, list) true
     * @allow (create) request.auth.uid == request.resource.data.ownerId
     * @allow (update, delete) request.auth.uid == resource.data.ownerId
     * @deny (create, update, delete) request.auth == null
     * @principle Public read, owner-only writes.
     */
    match /roles/{roleId} {
      function isOwner() {
        return request.auth.uid == resource.data.ownerId;
      }

      allow get: if true;
      allow list: if true;
      allow create: if request.auth.uid == request.resource.data.ownerId;
      allow update: if request.auth.uid == resource.data.ownerId;
      allow delete: if request.auth.uid == resource.data.ownerId;
    }


    /**
     * @description Allows anyone to read contacts, but only the owner can modify.
     * @path /contacts/{contactId}
     * @allow (get, list) true
     * @allow (create) request.auth.uid == request.resource.data.ownerId
     * @allow (update, delete) request.auth.uid == resource.data.ownerId
     * @deny (create, update, delete) request.auth == null
     * @principle Public read, owner-only writes.
     */
    match /contacts/{contactId} {
      function isOwner() {
        return request.auth.uid == resource.data.ownerId;
      }

      allow get: if true;
      allow list: if true;
      allow create: if request.auth.uid == request.resource.data.ownerId;
      allow update: if request.auth.uid == resource.data.ownerId;
      allow delete: if request.auth.uid == resource.data.ownerId;
    }

    /**
     * @description Allows anyone to read projects, but only the owner or team members can modify.
     * @path /projects/{projectId}
     * @allow (get, list) true
     * @allow (create) request.auth.uid == request.resource.data.ownerId
     * @allow (update, delete) request.auth.uid == resource.data.ownerId || request.resource.data.teamMembers.hasAny([request.auth.uid])
     * @deny (create, update, delete) request.auth == null
     * @principle Public read, owner/team-only writes.
     */
    match /projects/{projectId} {
      function isOwner() {
        return request.auth.uid == resource.data.ownerId;
      }
      function isTeamMember() {
          return request.auth.uid in resource.data.teamMembers;
      }

      allow get: if true;
      allow list: if true;
      allow create: if request.auth.uid == request.resource.data.ownerId;
      allow update: if isOwner() || (exists(resource.data.teamMembers) && isTeamMember());
      allow delete: if isOwner();
    }

    /**
     * @description Allows anyone to read project stages, but only project owners can modify.
     * @path /projects/{projectId}/stages/{stageId}
     */
    match /projects/{projectId}/stages/{stageId} {
      function isProjectOwner(projectId) {
        return get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isProjectOwner(projectId);
      allow update: if isProjectOwner(projectId);
      allow delete: if isProjectOwner(projectId);
    }

    /**
     * @description Allows anyone to read project tasks, but only project owners or assignees can modify.
     * @path /projects/{projectId}/tasks/{taskId}
     */
    match /projects/{projectId}/tasks/{taskId} {
      function isProjectOwner(projectId) {
        return get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid;
      }
      function isAssignee() {
        return request.auth.uid == resource.data.assigneeId;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isProjectOwner(projectId) || request.auth.uid == request.resource.data.assigneeId;
      allow update: if isProjectOwner(projectId) || isAssignee();
      allow delete: if isProjectOwner(projectId);
    }

    /**
     * @description Allows project members to read and write project files.
     * @path /projects/{projectId}/files/{fileId}
     */
    match /projects/{projectId}/files/{fileId} {
      function isProjectMember(projectId) {
          return request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers;
      }
        function isProjectOwner(projectId) {
            return get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid;
        }

      allow get: if true;
      allow list: if true;
      allow create: if exists(/databases/$(database)/documents/projects/$(projectId)) && isProjectMember(projectId);
      allow update: if exists(/databases/$(database)/documents/projects/$(projectId)) && isProjectMember(projectId);
      allow delete: if isProjectOwner(projectId);
    }

    /**
     * @description Allows chat participants to read and write chat metadata.
     * @path /chats/{chatId}
     */
    match /chats/{chatId} {
        function isParticipant() {
            return request.auth.uid in resource.data.userIds;
        }

        allow get: if isParticipant();
        allow list: if false;
        allow create: if request.auth.uid in request.resource.data.userIds;
        allow update: if isParticipant();
        allow delete: if false; // Chats should not be deleted.
    }

    /**
     * @description Allows chat participants to read and write messages.
     * @path /chats/{chatId}/messages/{messageId}
     */
    match /chats/{chatId}/messages/{messageId} {
        function isChatParticipant(chatId) {
            return request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.userIds;
        }

        allow get: if isChatParticipant(chatId);
        allow list: if isChatParticipant(chatId);
        allow create: if isChatParticipant(chatId);
        allow update: if false; // Messages should not be updated.
        allow delete: if false; // Messages should not be deleted.
    }

    /**
     * @description Allows anyone to read products, but only the owner can modify.
     * @path /products/{productId}
     * @allow (get, list) true
     * @allow (create) request.auth.uid == request.resource.data.ownerId
     * @allow (update, delete) request.auth.uid == resource.data.ownerId
     * @deny (create, update, delete) request.auth == null
     * @principle Public read, owner-only writes.
     */
    match /products/{productId} {
      function isOwner() {
        return request.auth.uid == resource.data.ownerId;
      }

      allow get: if true;
      allow list: if true;
      allow create: if request.auth.uid == request.resource.data.ownerId;
      allow update: if request.auth.uid == resource.data.ownerId;
      allow delete: if request.auth.uid == resource.data.ownerId;
    }

    /**
     * @description Allows anyone to read seals, but only the owner can modify.
     * @path /seals/{sealId}
     * @allow (get, list) true
     * @allow (create) request.auth.uid == request.resource.data.ownerId
     * @allow (update, delete) request.auth.uid == resource.data.ownerId
     * @deny (create, update, delete) request.auth == null
     * @principle Public read, owner-only writes.
     */
    match /seals/{sealId} {
      function isOwner() {
        return request.auth.uid == resource.data.ownerId;
      }

      allow get: if true;
      allow list: if true;
      allow create: if request.auth.uid == request.resource.data.ownerId;
      allow update: if request.auth.uid == resource.data.ownerId;
      allow delete: if request.auth.uid == resource.data.ownerId;
    }

    /**
     * @description Allows team members to read checklists, but only team leaders can modify.
     * @path /checklists/{checklistId}
     */
    match /checklists/{checklistId} {
      function isTeamMember(teamId) {
        return request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.memberIds;
      }
      function isTeamLeader(teamId) {
        return request.auth.uid == get(/databases/$(database)/documents/teams/$(teamId)).data.leaderId;
      }
      function getTeamId() {
          return get(/databases/$(database)/documents/checklists/$(checklistId)).data.teamId;
      }

      allow get: if true;
      allow list: if true;
      allow create: if exists(/databases/$(database)/documents/teams/$(request.resource.data.teamId)) && isTeamLeader(request.resource.data.teamId);
      allow update: if exists(/databases/$(database)/documents/teams/$(resource.data.teamId)) && isTeamLeader(resource.data.teamId);
      allow delete: if exists(/databases/$(database)/documents/teams/$(resource.data.teamId)) && isTeamLeader(resource.data.teamId);
    }

    /**
     * @description Allows team members to read checklist items, but only team leaders can modify.
     * @path /checklists/{checklistId}/items/{itemId}
     */
    match /checklists/{checklistId}/items/{itemId} {
      function isTeamMember(teamId) {
        return request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.memberIds;
      }
      function isTeamLeader(teamId) {
        return request.auth.uid == get(/databases/$(database)/documents/teams/$(teamId)).data.leaderId;
      }
        function getTeamId(checklistId) {
            return get(/databases/$(database)/documents/checklists/$(checklistId)).data.teamId;
        }

      allow get: if true;
      allow list: if true;
      allow create: if exists(/databases/$(database)/documents/checklists/$(checklistId)) && exists(/databases/$(database)/documents/teams/$(request.resource.data.teamId)) && isTeamLeader(request.resource.data.teamId);
      allow update: if exists(/databases/$(database)/documents/checklists/$(checklistId)) && exists(/databases/$(database)/documents/teams/$(resource.data.teamId)) && isTeamLeader(resource.data.teamId);
      allow delete: if exists(/databases/$(database)/documents/checklists/$(checklistId)) && exists(/databases/$(database)/documents/teams/$(resource.data.teamId)) && isTeamLeader(resource.data.teamId);
    }
  }
}