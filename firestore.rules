/**
 * @fileOverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles and their associated data,
 * shared access for chats, and role-based access where applicable. A 'dev' role bypasses all checks.
 * Data validation is relaxed for rapid prototyping, focusing primarily on authorization.
 *
 * Data Structure:
 * - Users: Data is nested under /users/{userId}.
 * - Teams, Roles, Contacts, Products, Seals, Checklists: Stored in top-level collections.
 * - Projects: Stored in a top-level collection, with stages, tasks, and files nested beneath them.
 * - Chats: Stored in a top-level collection, with messages nested beneath them.
 *
 * Key Security Decisions:
 * - Users can only read/write their own profile data.
 * - Listing users is disallowed.
 * - Chats are accessible to members only.
 * - Projects are accessible to team members and the owner.
 *
 * Denormalization for Authorization:
 *  - Projects include an `ownerId` and `teamMembers` array for efficient authorization checks.
 *  - Chats include `userIds` array for efficient authorization checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user's UID matches the provided userId.
     * @param {string} userId - The user ID to compare against the authenticated user's UID.
     * @returns {boolean} True if the user is an owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the current user is signed in and has the "dev" role.
     * @returns {boolean} True if the user is a dev, false otherwise.
     */
    function isDev() {
      return isSignedIn() && request.auth.token.role == 'dev';
    }

    /**
     * @description Checks if the current user is an existing owner of a document.
     * @param {string} userId - The user ID to compare against the authenticated user's UID.
     * @returns {boolean} True if the user is an owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Determines if the current user is a member of the specified chat.
     * @param {array} userIds - An array of user IDs who are members of the chat.
     * @returns {boolean} True if the user is a member, false otherwise.
     */
    function isChatMember(userIds) {
      return isSignedIn() && userIds.hasAny([request.auth.uid]);
    }

    /**
     * @description Checks if the user is part of a project's team.
     * @param {array} teamMembers - Array of user IDs who are team members.
     * @returns {boolean} True if the user is a team member, false otherwise.
     */
    function isTeamMember(teamMembers) {
      return isSignedIn() && teamMembers.hasAny([request.auth.uid]);
    }


    /**
     * @description Rules for user documents.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own user document.
     * @allow (get, update, delete) - Authenticated user can access their own user document.
     * @deny (create) - Unauthenticated user cannot create user document.
     * @deny (get, update, delete) - Authenticated user cannot access another user document.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isDev();
      allow list: if false; // Listing users is not permitted

      allow create: if isOwner(userId) || isDev();
      allow update: if isExistingOwner(userId) || isDev();
      allow delete: if isExistingOwner(userId) || isDev();
    }

    /**
     * @description Rules for user notifications.
     * @path /users/{userId}/notifications/{notificationId}
     * @allow (create) - Authenticated user can create notifications for themselves.
     * @allow (get, update, delete) - Authenticated user can access their own notifications.
     * @deny (create) - Unauthenticated user cannot create notifications.
     * @deny (get, update, delete) - Authenticated user cannot access another user's notifications.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/notifications/{notificationId} {
      allow get: if isOwner(userId) || isDev();
      allow list: if isOwner(userId) || isDev();

      allow create: if isOwner(userId) || isDev();
      allow update: if isExistingOwner(userId) || isDev();
      allow delete: if isExistingOwner(userId) || isDev();
    }

    /**
     * @description Rules for teams.
     * @path /teams/{teamId}
     * @allow (create, get, update, delete) - Any authenticated user can manage teams.
     * @principle Allows any authenticated user to manage teams.
     */
    match /teams/{teamId} {
      allow get: if isSignedIn() || isDev();
      allow list: if isSignedIn() || isDev();

      allow create: if isSignedIn() || isDev();
      allow update: if resource != null && isSignedIn() || isDev();
      allow delete: if resource != null && isSignedIn() || isDev();
    }

    /**
     * @description Rules for roles.
     * @path /roles/{roleId}
     * @allow (create, get, update, delete) - Any authenticated user can manage roles.
     * @principle Allows any authenticated user to manage roles.
     */
    match /roles/{roleId} {
      allow get: if isSignedIn() || isDev();
      allow list: if isSignedIn() || isDev();

      allow create: if isSignedIn() || isDev();
      allow update: if resource != null && isSignedIn() || isDev();
      allow delete: if resource != null && isSignedIn() || isDev();
    }

    /**
     * @description Rules for contacts.
     * @path /contacts/{contactId}
     * @allow (create, get, update, delete) - Any authenticated user can manage contacts.
     * @principle Allows any authenticated user to manage contacts.
     */
    match /contacts/{contactId} {
      allow get: if isSignedIn() || isDev();
      allow list: if isSignedIn() || isDev();

      allow create: if isSignedIn() || isDev();
      allow update: if resource != null && isSignedIn() || isDev();
      allow delete: if resource != null && isSignedIn() || isDev();
    }

    /**
     * @description Rules for projects.
     * @path /projects/{projectId}
     * @allow (create) - Authenticated user can create a project. The 'ownerId' field must match the user's UID.
     * @allow (get, update, delete) - Only the project owner or team members can access/modify a project.
     * @principle Enforces project ownership and shared team access.
     */
    match /projects/{projectId} {
      allow get: if (isSignedIn() && (resource.data.ownerId == request.auth.uid || isTeamMember(resource.data.teamMembers))) || isDev();
      allow list: if isSignedIn() || isDev();

      allow create: if isSignedIn() || isDev();
      allow update: if resource != null && (resource.data.ownerId == request.auth.uid || isTeamMember(resource.data.teamMembers)) || isDev();
      allow delete: if resource != null && (resource.data.ownerId == request.auth.uid || isTeamMember(resource.data.teamMembers)) || isDev();
    }

    /**
     * @description Rules for stages within a project.
     * @path /projects/{projectId}/stages/{stageId}
     *  @allow (get, list) - Project team members can read stages.
     * @allow (create, update, delete) - Project owner can create, update and delete stages.
     * @principle Restricts stage management to project owners.
     */
    match /projects/{projectId}/stages/{stageId} {
      allow get: if (isSignedIn() && (get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isTeamMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers))) || isDev();
      allow list: if (isSignedIn() && (get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isTeamMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers))) || isDev();

      allow create: if isSignedIn() && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isDev();
      allow update: if resource != null && isSignedIn() && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isDev();
      allow delete: if resource != null && isSignedIn() && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isDev();
    }

    /**
     * @description Rules for tasks within a project.
     * @path /projects/{projectId}/tasks/{taskId}
     * @allow (get, list) - Project team members can read tasks.
     * @allow (create, update, delete) - Project owner can create, update and delete tasks.
     * @principle Restricts task management to project owners.
     */
    match /projects/{projectId}/tasks/{taskId} {
      allow get: if (isSignedIn() && (get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isTeamMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers))) || isDev();
      allow list: if (isSignedIn() && (get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isTeamMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers))) || isDev();

      allow create: if isSignedIn() && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isDev();
      allow update: if resource != null && isSignedIn() && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isDev();
      allow delete: if resource != null && isSignedIn() && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isDev();
    }

    /**
     * @description Rules for files within a project.
     * @path /projects/{projectId}/files/{fileId}
     * @allow (get, list) - Project team members can read files.
     * @allow (create, update, delete) - Project owner can create, update and delete files.
     * @principle Restricts file management to project owners.
     */
    match /projects/{projectId}/files/{fileId} {
      allow get: if (isSignedIn() && (get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isTeamMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers))) || isDev();
      allow list: if (isSignedIn() && (get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isTeamMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers))) || isDev();

      allow create: if isSignedIn() && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isDev();
      allow update: if resource != null && isSignedIn() && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isDev();
      allow delete: if resource != null && isSignedIn() && get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isDev();
    }

    /**
     * @description Rules for chats.
     * @path /chats/{chatId}
     * @allow (create) - Any authenticated user can create a chat.
     * @allow (get, update, delete) - Only members of the chat can access it.
     * @principle Enforces shared access for chat participants.
     */
    match /chats/{chatId} {
      allow get: if isChatMember(resource.data.userIds) || isDev();
      allow list: if isSignedIn() || isDev();

      allow create: if isSignedIn() || isDev();
      allow update: if resource != null && isChatMember(resource.data.userIds) || isDev();
      allow delete: if resource != null && isChatMember(resource.data.userIds) || isDev();
    }

    /**
     * @description Rules for messages within a chat.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (create) - Only members of the chat can create messages.
     * @allow (get, update, delete) - Only members of the chat can access messages.
     * @principle Enforces shared access for chat participants.
     */
    match /chats/{chatId}/messages/{messageId} {
      allow get: if isChatMember(get(/databases/$(database)/documents/chats/$(chatId)).data.userIds) || isDev();
      allow list: if isChatMember(get(/databases/$(database)/documents/chats/$(chatId)).data.userIds) || isDev();

      allow create: if isChatMember(get(/databases/$(database)/documents/chats/$(chatId)).data.userIds) || isDev();
      allow update: if resource != null && isChatMember(get(/databases/$(database)/documents/chats/$(chatId)).data.userIds) || isDev();
      allow delete: if resource != null && isChatMember(get(/databases/$(database)/documents/chats/$(chatId)).data.userIds) || isDev();
    }

    /**
     * @description Rules for products.
     * @path /products/{productId}
     * @allow (create, get, update, delete) - Any authenticated user can manage products.
     * @principle Allows any authenticated user to manage products.
     */
    match /products/{productId} {
      allow get: if isSignedIn() || isDev();
      allow list: if isSignedIn() || isDev();

      allow create: if isSignedIn() || isDev();
      allow update: if resource != null && isSignedIn() || isDev();
      allow delete: if resource != null && isSignedIn() || isDev();
    }

    /**
     * @description Rules for seals.
     * @path /seals/{sealId}
     * @allow (create, get, update, delete) - Any authenticated user can manage seals.
     * @principle Allows any authenticated user to manage seals.
     */
    match /seals/{sealId} {
      allow get: if isSignedIn() || isDev();
      allow list: if isSignedIn() || isDev();

      allow create: if isSignedIn() || isDev();
      allow update: if resource != null && isSignedIn() || isDev();
      allow delete: if resource != null && isSignedIn() || isDev();
    }

    /**
     * @description Rules for checklists.
     * @path /checklists/{checklistId}
     * @allow (create, get, update, delete) - Any authenticated user can manage checklists.
     */
    match /checklists/{checklistId} {
      allow get: if isSignedIn() || isDev();
      allow list: if isSignedIn() || isDev();

      allow create: if isSignedIn() || isDev();
      allow update: if resource != null && isSignedIn() || isDev();
      allow delete: if resource != null && isSignedIn() || isDev();
    }

    /**
     * @description Rules for checklist items.
     * @path /checklists/{checklistId}/items/{itemId}
     *  @allow (get, list) - Any authenticated user can read checklist items.
     * @allow (create, update, delete) - Any authenticated user can create, update and delete checklist items.
     */
    match /checklists/{checklistId}/items/{itemId} {
      allow get: if isSignedIn() || isDev();
      allow list: if isSignedIn() || isDev();

      allow create: if isSignedIn() || isDev();
      allow update: if resource != null && isSignedIn() || isDev();
      allow delete: if resource != null && isSignedIn() || isDev();
    }
  }
}