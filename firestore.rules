/**
 * @fileoverview Firestore Security Rules for Prototyping.
 *
 * Core Philosophy: This ruleset prioritizes rapid prototyping by providing a flexible
 * security model focused on user ownership and developer/manager overrides. It enforces
 * strict authorization, but relaxes schema validation to allow for faster data model iteration.
 *
 * Data Structure:
 * - User-owned data is nested under `/users/{userId}`.
 * - Projects, Tasks, Stages, Teams, Roles, Contacts, Products, and Seals are top-level collections.
 * - ProjectFiles are stored as subcollections of Projects (`/projects/{projectId}/files/{fileId}`).
 * - Chats are top-level collections, with messages in subcollections (`/chats/{chatId}/messages/{messageId}`).
 * - Checklists are top-level collections, with checklist items in subcollections (`/checklists/{checklistId}/items/{itemId}`).
 *
 * Key Security Decisions:
 * - User listing is disabled for privacy.
 * - All write operations (create, update, delete) require authentication.
 * - Helper functions abstract complex logic for readability and maintainability.
 * - Roles are handled via custom claims (`isDev`, `isManager`) for elevated permissions.
 *
 * Denormalization for Authorization:
 * - Projects denormalize the `ownerId` to easily enforce project ownership.
 * - ProjectFiles denormalize the `uploaderId` to easily enforce file ownership within a project.
 * - Chats denormalize the `userIds` array to efficiently check user participation.
 *
 * Structural Segregation:
 * - Public vs. Private: The data model does not clearly distinguish between public and private content.
 *   If a requirement emerges to support public access (e.g., for read-only content), the preferred approach is to duplicate data
 *   into a separate, top-level collection with open read permissions, while maintaining the original, secured data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the resource.
     * @param {string} userId - The user ID to compare with the resource's owner ID.
     * @returns {boolean} True if the user is the owner, false otherwise.
     * @example
     *   allow read: if isOwner(resource.data.ownerId);
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

        /**
     * @description Checks if the user is the owner of the resource and the resource exists.
     *              Useful for update and delete operations to prevent acting on non-existent data.
     * @param {string} userId - The user ID to compare with the resource's owner ID.
     * @returns {boolean} True if the user is the owner and the resource exists, false otherwise.
     * @example
     *   allow update, delete: if isExistingOwner(resource.data.ownerId);
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user has the 'isDev' custom claim.
     * @returns {boolean} True if the user is a developer, false otherwise.
     * @example
     *   allow read, write: if isDev();
     */
    function isDev() {
        return isSignedIn() && request.auth.token.isDev == true;
    }

    /**
     * @description Checks if the user has the 'isManager' custom claim.
     * @returns {boolean} True if the user is a manager, false otherwise.
     * @example
     *   allow read, write: if isManager();
     */
    function isManager() {
        return isSignedIn() && request.auth.token.isManager == true;
    }

    /**
     * @description Checks if the authenticated user is a participant in the chat.
     * @param {array} userIds - An array of user IDs that are part of the chat.
     * @returns {boolean} True if the user is a participant, false otherwise.
     * @example
     *   allow read: if isChatParticipant(resource.data.userIds);
     */
    function isChatParticipant(userIds) {
        return isSignedIn() && userIds.hasAny([request.auth.uid]);
    }

    match /users/{userId} {
      /**
       * @description Controls access to user profiles.
       * @path /users/{userId}
       * @allow (create) User creates their own profile with matching UID.
       * @allow (get, update, delete) User accesses their own profile.
       * @deny (create) User attempts to create a profile with a mismatched UID.
       * @deny (list) Listing all users is prohibited for privacy.
       * @principle Enforces document ownership, prevents user enumeration.
       */
      allow get: if isOwner(userId) || isDev();
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId) || isDev();
    }

    match /users/{userId}/notifications/{notificationId} {
      /**
       * @description Controls access to a user's notifications.
       * @path /users/{userId}/notifications/{notificationId}
       * @allow (create) User creates their own notification, ownerId matches user id.
       * @allow (get, list, update, delete) User accesses their own notifications.
       * @deny (create) User attempts to create a notification for another user.
       * @principle Enforces document ownership.
       */
      allow get: if isOwner(userId) || isDev();
      allow list: if isOwner(userId) || isDev();
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId) || isDev();
      allow delete: if isExistingOwner(userId) || isDev();
    }

    match /teams/{teamId} {
      /**
       * @description Controls access to teams.
       * @path /teams/{teamId}
       * @allow (get, list) Anyone can read teams.
       * @allow (create, update, delete) Only developers can manage teams.
       * @principle Allows public reading, restricts modifications to developers.
       */
      allow get, list: if true;
      allow create: if isDev() || isManager();
      allow update: if isDev() || isManager();
      allow delete: if isDev() || isManager();
    }

    match /roles/{roleId} {
      /**
       * @description Controls access to roles.
       * @path /roles/{roleId}
       * @allow (get, list) Anyone can read roles.
       * @allow (create, update, delete) Only developers can manage roles.
       * @principle Allows public reading, restricts modifications to developers.
       */
      allow get, list: if true;
      allow create: if isDev() || isManager();
      allow update: if isDev() || isManager();
      allow delete: if isDev() || isManager();
    }

    match /contacts/{contactId} {
      /**
       * @description Controls access to contacts.
       * @path /contacts/{contactId}
       * @allow (get, list) Anyone can read contacts.
       * @allow (create, update, delete) Only developers can manage contacts.
       * @principle Allows public reading, restricts modifications to developers.
       */
      allow get, list: if true || isDev() || isManager();
      allow create: if isDev() || isManager();
      allow update: if isDev() || isManager();
      allow delete: if isDev() || isManager();
    }

    match /projects/{projectId} {
      /**
       * @description Controls access to projects.
       * @path /projects/{projectId}
       * @allow (get, list) Anyone can read projects.
       * @allow (create) Only authenticated users can create projects, and the `ownerId` must match their UID.
       * @allow (update, delete) Only the project owner or a developer can modify projects.
       * @deny   (create) If the `ownerId` doesn't match the authenticated user's UID.
       * @principle Enforces project ownership.
       */
      allow get, list: if true || isDev() || isManager();
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.ownerId) || isDev() || isManager();
      allow delete: if isExistingOwner(resource.data.ownerId) || isDev() || isManager();
    }

    match /projects/{projectId}/stages/{stageId} {
      /**
       * @description Controls access to stages within a project.
       * @path /projects/{projectId}/stages/{stageId}
       * @allow (get, list) Anyone can read stages within a project.
       * @allow (create, update, delete) Only the project owner or a developer can manage stages.
       * @principle Enforces project ownership for modifications.
       */
      allow get, list: if true || isDev() || isManager();
      allow create: if get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isDev() || isManager();
      allow update: if get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isDev() || isManager();
      allow delete: if get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isDev() || isManager();
    }

    match /projects/{projectId}/tasks/{taskId} {
      /**
       * @description Controls access to tasks within a project.
       * @path /projects/{projectId}/tasks/{taskId}
       * @allow (get, list) Anyone can read tasks within a project.
       * @allow (create, update, delete) Only the project owner or a developer can manage tasks.
       * @principle Enforces project ownership for modifications.
       */
      allow get, list: if true || isDev() || isManager();
      allow create: if get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isDev() || isManager();
      allow update: if get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isDev() || isManager();
      allow delete: if get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid || isDev() || isManager();
    }

    match /projects/{projectId}/files/{fileId} {
      /**
       * @description Controls access to files within a project.
       * @path /projects/{projectId}/files/{fileId}
       * @allow (get, list) Anyone can read files within a project.
       * @allow (create) Only authenticated users can create project files, and the `uploaderId` must match their UID.
       * @allow (update, delete) Only the uploader or a developer can modify files.
       * @deny   (create) If the `uploaderId` doesn't match the authenticated user's UID.
       * @principle Enforces project file ownership.
       */
      allow get, list: if true || isDev() || isManager();
      allow create: if isSignedIn() && request.resource.data.uploaderId == request.auth.uid;
      allow update: if request.resource.data.uploaderId == resource.data.uploaderId || isDev() || isManager();
      allow delete: if resource.data.uploaderId == request.auth.uid || isDev() || isManager();
    }

    match /chats/{chatId} {
      /**
       * @description Controls access to chats.
       * @path /chats/{chatId}
       * @allow (get, list) Only participants can read chats.
       * @allow (create) Only authenticated users can create chats, and they must be a participant.
       * @allow (update, delete) Only developers can update or delete chats.
       * @principle Enforces chat participation.
       */
      allow get: if isChatParticipant(resource.data.userIds) || isDev() || isManager();
      allow list: if isSignedIn() || isDev() || isManager();
      allow create: if isSignedIn() && request.resource.data.userIds.hasAny([request.auth.uid]);
      allow update: if isDev() || isManager();
      allow delete: if isDev() || isManager();
    }

    match /chats/{chatId}/messages/{messageId} {
      /**
       * @description Controls access to messages within a chat.
       * @path /chats/{chatId}/messages/{messageId}
       * @allow (get, list) Only chat participants can read messages.
       * @allow (create) Only chat participants can create messages.
       * @allow (update, delete) Only developers can update or delete messages.
       * @principle Enforces chat participation.
       */
      allow get, list: if get(/databases/$(database)/documents/chats/$(chatId)).data.userIds.hasAny([request.auth.uid]) || isDev() || isManager();
      allow create: if get(/databases/$(database)/documents/chats/$(chatId)).data.userIds.hasAny([request.auth.uid]) || isDev() || isManager();
      allow update: if isDev() || isManager();
      allow delete: if isDev() || isManager();
    }

        match /products/{productId} {
      /**
       * @description Controls access to products.
       * @path /products/{productId}
       * @allow (get, list) Anyone can read products.
       * @allow (create, update, delete) Only developers can manage products.
       * @principle Allows public reading, restricts modifications to developers.
       */
      allow get, list: if true || isDev() || isManager();
      allow create: if isDev() || isManager();
      allow update: if isDev() || isManager();
      allow delete: if isDev() || isManager();
    }

    match /seals/{sealId} {
      /**
       * @description Controls access to seals.
       * @path /seals/{sealId}
       * @allow (get, list) Anyone can read seals.
       * @allow (create, update, delete) Only developers can manage seals.
       * @principle Allows public reading, restricts modifications to developers.
       */
      allow get, list: if true || isDev() || isManager();
      allow create: if isDev() || isManager();
      allow update: if isDev() || isManager();
      allow delete: if isDev() || isManager();
    }

    match /checklists/{checklistId} {
      /**
       * @description Controls access to checklists.
       * @path /checklists/{checklistId}
       * @allow (get, list) Anyone can read checklists.
       * @allow (create, update, delete) Only developers can manage checklists.
       * @principle Allows public reading, restricts modifications to developers.
       */
      allow get, list: if true || isDev() || isManager();
      allow create: if isDev() || isManager();
      allow update: if isDev() || isManager();
      allow delete: if isDev() || isManager();
    }

    match /checklists/{checklistId}/items/{itemId} {
      /**
       * @description Controls access to checklist items.
       * @path /checklists/{checklistId}/items/{itemId}
       * @allow (get, list) Anyone can read checklist items.
       * @allow (create, update, delete) Only developers can manage checklist items.
       * @principle Allows public reading, restricts modifications to developers.
       */
      allow get, list: if true || isDev() || isManager();
      allow create: if isDev() || isManager();
      allow update: if isDev() || isManager();
      allow delete: if isDev() || isManager();
    }
  }
}