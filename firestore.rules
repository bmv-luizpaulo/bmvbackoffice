/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user profiles and their associated data.
 *  Projects, tasks, and other collaborative entities are secured using a shared access pattern based on denormalized member lists.
 *  Public read access is granted to specific collections where owner-only writes are enforced.
 *
 * @dataStructure
 *  - /users/{userId}: User profiles, secured with owner-only access.
 *  - /users/{userId}/notifications/{notificationId}: Notifications for a specific user, secured with owner-only access.
 *  - /teams/{teamId}: Teams within the organization.
 *  - /roles/{roleId}: User roles.
 *  - /contacts/{contactId}: Contacts (clients, suppliers, partners).
 *  - /projects/{projectId}: Projects, secured with shared access (teamMembers array).
 *  - /projects/{projectId}/stages/{stageId}: Stages within a project, inheriting project-level security.
 *  - /projects/{projectId}/tasks/{taskId}: Tasks within a stage, inheriting project-level security.
 *  - /projects/{projectId}/files/{fileId}: Files associated with a project, inheriting project-level security.
 *  - /chats/{chatId}: Chat metadata, secured with shared access (userIds array).
 *  - /chats/{chatId}/messages/{messageId}: Messages within a chat, inheriting chat-level security.
 *  - /products/{productId}: Products that can be certified (public read, owner-only writes).
 *  - /seals/{sealId}: Certification seals issued (public read, owner-only writes).
 *  - /checklists/{checklistId}: Checklist templates.
 *  - /checklists/{checklistId}/items/{itemId}: Checklist items.
 *
 * @keySecurityDecisions
 *  - User listing is explicitly denied.
 *  - Shared access is implemented by storing member UIDs directly on project and chat documents.
 *
 * @denormalizationForAuthorization
 *  - Projects and Chats store user IDs (teamMembers, userIds) directly on the document to avoid costly `get()` calls in security rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user authentication status
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource and it exists.
     *  This is for update and delete operations, which must verify existence.
     */
    function isExistingOwner(userId) {
      return (isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId)));
    }

    /**
     * @description Checks if the authenticated user is a member of the project (present in the teamMembers array).
     */
    function isProjectMember(teamMembers) {
      return teamMembers.hasAny([request.auth.uid]);
    }

    /**
     * @description Checks if the authenticated user is a member of the chat (present in the userIds array).
     */
    function isChatMember(userIds) {
      return userIds.hasAny([request.auth.uid]);
    }
    
    /**
     * @description Checks if the request is coming from one of the development users specified in the user request.
     */
    function isDevUser() {
        let devUsers = ["aXppOyBAkqTbtWElCK7RFQ7xbmW2", "lxm9BGJOYqOw9ODiAKP6xp4nKTV2"];
        return isSignedIn() && devUsers.hasAny([request.auth.uid]);
    }
    
    /**
     * @description Allows only dev users to create, update, and delete documents.
     */
    function allowDevWrites() {
        return isDevUser();
    }


    /**
     * @description Grants owner-only access to user profiles.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' creates their profile.
     *  `request.auth.uid == 'user123'` and the document ID is also 'user123'.
     * @allow (get) User with ID 'user123' reads their profile.
     *  `request.auth.uid == 'user123'`.
     * @deny (create) User with ID 'user123' attempts to create a profile for 'user456'.
     *  `request.auth.uid == 'user123'` but the document ID is 'user456'.
     * @deny (update) User with ID 'user123' attempts to update a profile that doesn't exist.
     *  `resource == null`.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.auth.uid == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants owner-only access to user notifications.
     * @path /users/{userId}/notifications/{notificationId}
     * @allow (create) User with ID 'user123' creates a notification for themselves.
     *  `request.auth.uid == 'user123'`.
     * @allow (get) User with ID 'user123' reads a notification for themselves.
     *  `request.auth.uid == 'user123'`.
     * @deny (create) User with ID 'user123' attempts to create a notification for 'user456'.
     *  `request.auth.uid == 'user123'` but the parent user ID is 'user456'.
     * @deny (update) User with ID 'user123' attempts to update a notification that doesn't exist.
     *  `resource == null`.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/notifications/{notificationId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants read access to all users, but only dev users to create, update, or delete teams.
     * @path /teams/{teamId}
     * @allow (get) Any user can read a team.
     *  `isSignedIn()`.
     * @allow (create) Dev user creates a team.
     *  `isDevUser()`.
     * @deny (create) Non-dev user attempts to create a team.
     *  `!isDevUser()`.
     * @principle Allows public read access but restricts writes to dev users.
     */
    match /teams/{teamId} {
      allow get, list: if true;
      allow create: if allowDevWrites();
      allow update: if allowDevWrites();
      allow delete: if allowDevWrites();
    }

    /**
     * @description Grants read access to all users, but only dev users to create, update, or delete roles.
     * @path /roles/{roleId}
     */
    match /roles/{roleId} {
        allow get, list: if true;
        allow create: if allowDevWrites();
        allow update: if allowDevWrites();
        allow delete: if allowDevWrites();
    }

    /**
     * @description Grants read access to all users, but only dev users to create, update, or delete contacts.
     * @path /contacts/{contactId}
     */
    match /contacts/{contactId} {
        allow get, list: if true;
        allow create: if allowDevWrites();
        allow update: if allowDevWrites();
        allow delete: if allowDevWrites();
    }

    /**
     * @description Grants shared access to projects based on the teamMembers array.
     * @path /projects/{projectId}
     * @allow (get) User 'user123' reads a project they are a member of.
     *  `request.auth.uid == 'user123'` and 'user123' is in the `teamMembers` array.
     * @allow (create) User 'user123' creates a project and includes themself in `teamMembers`.
     *  `request.auth.uid == 'user123'` and `request.resource.data.ownerId == 'user123'`.
     * @deny (get) User 'user456' attempts to read a project they are not a member of.
     *  `request.auth.uid == 'user456'` but 'user456' is not in the `teamMembers` array.
     * @principle Enforces shared access based on membership in the `teamMembers` array.
     */
    match /projects/{projectId} {
      allow get: if isSignedIn() && resource.data.teamMembers is list && isProjectMember(resource.data.teamMembers);
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid && request.resource.data.teamMembers is list && isProjectMember(request.resource.data.teamMembers);
      allow update: if isSignedIn() && resource.data.teamMembers is list && isProjectMember(resource.data.teamMembers);
      allow delete: if isSignedIn() && resource.data.teamMembers is list && isProjectMember(resource.data.teamMembers);
    }

    /**
     * @description Grants access to project stages based on project membership.
     * @path /projects/{projectId}/stages/{stageId}
     * @allow (get) User 'user123' reads a stage in a project they are a member of.
     *  `request.auth.uid == 'user123'` and 'user123' is in the `teamMembers` array of the parent project.
     * @deny (create) User 'user456' attempts to create a stage in a project they are not a member of.
     *  `request.auth.uid == 'user456'` but 'user456' is not in the `teamMembers` array of the parent project.
     * @principle Inherits security from the parent project.
     */
    match /projects/{projectId}/stages/{stageId} {
      allow get, list: if isSignedIn() && isProjectMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers);
      allow create: if isSignedIn() && isProjectMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers);
      allow update: if isSignedIn() && isProjectMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers);
      allow delete: if isSignedIn() && isProjectMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers);
    }

    /**
     * @description Grants access to project tasks based on project membership.
     * @path /projects/{projectId}/tasks/{taskId}
     * @allow (get) User 'user123' reads a task in a project they are a member of.
     *  `request.auth.uid == 'user123'` and 'user123' is in the `teamMembers` array of the parent project.
     * @deny (create) User 'user456' attempts to create a task in a project they are not a member of.
     *  `request.auth.uid == 'user456'` but 'user456' is not in the `teamMembers` array of the parent project.
     * @principle Inherits security from the parent project.
     */
    match /projects/{projectId}/tasks/{taskId} {
      allow get, list: if isSignedIn() && isProjectMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers);
      allow create: if isSignedIn() && isProjectMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers);
      allow update: if isSignedIn() && isProjectMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers);
      allow delete: if isSignedIn() && isProjectMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers);
    }

        /**
     * @description Grants access to project files based on project membership.
     * @path /projects/{projectId}/files/{fileId}
     * @allow (get) User 'user123' reads a file in a project they are a member of.
     *  `request.auth.uid == 'user123'` and 'user123' is in the `teamMembers` array of the parent project.
     * @deny (create) User 'user456' attempts to create a file in a project they are not a member of.
     *  `request.auth.uid == 'user456'` but 'user456' is not in the `teamMembers` array of the parent project.
     * @principle Inherits security from the parent project.
     */
    match /projects/{projectId}/files/{fileId} {
      allow get, list: if isSignedIn() && isProjectMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers);
      allow create: if isSignedIn() && isProjectMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers);
      allow update: if isSignedIn() && isProjectMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers);
      allow delete: if isSignedIn() && isProjectMember(get(/databases/$(database)/documents/projects/$(projectId)).data.teamMembers);
    }

    /**
     * @description Grants shared access to chats based on the userIds array.
     * @path /chats/{chatId}
     * @allow (get) User 'user123' reads a chat they are a member of.
     *  `request.auth.uid == 'user123'` and 'user123' is in the `userIds` array.
     * @allow (create) User 'user123' creates a chat and includes themself in `userIds`.
     *  `request.auth.uid == 'user123'` and 'user123' is in the `userIds` array of the new document.
     * @deny (get) User 'user456' attempts to read a chat they are not a member of.
     *  `request.auth.uid == 'user456'` but 'user456' is not in the `userIds` array.
     * @principle Enforces shared access based on membership in the `userIds` array.
     */
    match /chats/{chatId} {
      allow get: if isSignedIn() && resource.data.userIds is list && isChatMember(resource.data.userIds);
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userIds is list && isChatMember(request.resource.data.userIds);
      allow update: if isSignedIn() && resource.data.userIds is list && isChatMember(resource.data.userIds);
      allow delete: if isSignedIn() && resource.data.userIds is list && isChatMember(resource.data.userIds);
    }

    /**
     * @description Grants access to chat messages based on chat membership.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (get) User 'user123' reads a message in a chat they are a member of.
     *  `request.auth.uid == 'user123'` and 'user123' is in the `userIds` array of the parent chat.
     * @deny (create) User 'user456' attempts to create a message in a chat they are not a member of.
     *  `request.auth.uid == 'user456'` but 'user456' is not in the `userIds` array of the parent chat.
     * @principle Inherits security from the parent chat.
     */
    match /chats/{chatId}/messages/{messageId} {
      allow get, list: if isSignedIn() && isChatMember(get(/databases/$(database)/documents/chats/$(chatId)).data.userIds);
      allow create: if isSignedIn() && isChatMember(get(/databases/$(database)/documents/chats/$(chatId)).data.userIds);
      allow update: if isSignedIn() && isChatMember(get(/databases/$(database)/documents/chats/$(chatId)).data.userIds);
      allow delete: if isSignedIn() && isChatMember(get(/databases/$(database)/documents/chats/$(chatId)).data.userIds);
    }

    /**
     * @description Grants public read access to products, but restricts writes to owner only.
     *  The 'Product' entity is missing an 'ownerId' or 'authorId' field.
     * @path /products/{productId}
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if allowDevWrites(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if allowDevWrites();
      allow delete: if allowDevWrites();
    }

    /**
     * @description Grants public read access to seals, but restricts writes to owner only.
     *  The 'Seal' entity is missing an 'ownerId' or 'authorId' field.
     * @path /seals/{sealId}
     */
    match /seals/{sealId} {
      allow get, list: if true;
      allow create: if allowDevWrites();// TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if allowDevWrites();
      allow delete: if allowDevWrites();
    }

    /**
     * @description Grants read access to all users, but only dev users to create, update, or delete checklists.
     * @path /checklists/{checklistId}
     */
    match /checklists/{checklistId} {
      allow get, list: if true;
      allow create: if allowDevWrites();
      allow update: if allowDevWrites();
      allow delete: if allowDevWrites();
    }

    /**
     * @description Grants read access to all users, but only dev users to create, update, or delete checklist items.
     * @path /checklists/{checklistId}/items/{itemId}
     */
    match /checklists/{checklistId}/items/{itemId} {
      allow get, list: if true;
      allow create: if allowDevWrites();
      allow update: if allowDevWrites();
      allow delete: if allowDevWrites();
    }
  }
}